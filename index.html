<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Urban Renew - Community Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: #f5f5f5; }
    #map { height: 100%; width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

    #locateBtn, #signInBtn, #signOutBtn {
      position: absolute; top: 10px; z-index: 1000;
      background: #4285f4; color: white; border: none;
      padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    #locateBtn { left: 50%; transform: translateX(-50%); }
    #signInBtn { left: 10px; background: #34A853; }
    #signOutBtn { left: 10px; background: #DB4437; display: none; }

    #locateBtn:hover, #signInBtn:hover, #signOutBtn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <button id="signInBtn">🔑 Sign in with Google</button>
  <button id="signOutBtn">🚪 Sign out</button>
  <button id="locateBtn">📍 Find My Location</button>
  <div id="map"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBuQI813zZeJj4RSlU2_fsBb20lWTCqa7o",
      authDomain: "urban-renew-map.firebaseapp.com",
      databaseURL: "https://urban-renew-map-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "urban-renew-map",
      storageBucket: "urban-renew-map.appspot.com",
      messagingSenderId: "138295290989",
      appId: "1:138295290989:web:3ae9ce333ebc4a1a6aa364",
      measurementId: "G-6GXK4MHR0Q"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const PASSWORD = "AT@chat/gpt";
    let currentUser = null;

    // --- Auth buttons ---
    document.getElementById("signInBtn").onclick = () => {
      auth.signInWithPopup(provider).then(result => {
        currentUser = result.user;
        alert("Signed in as " + result.user.displayName);
        document.getElementById("signInBtn").style.display = "none";
        document.getElementById("signOutBtn").style.display = "block";
      }).catch(error => alert("Error: " + error.message));
    };

    document.getElementById("signOutBtn").onclick = () => {
      auth.signOut().then(() => {
        currentUser = null;
        alert("Signed out.");
        document.getElementById("signInBtn").style.display = "block";
        document.getElementById("signOutBtn").style.display = "none";
      });
    };

    // --- Map setup ---
    const map = L.map('map').setView([22.9734, 78.6569], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const markerMap = {};

    // --- Load pins from Firebase ---
    db.ref("pins").on("value", snapshot => {
      const pins = snapshot.val() || {};
      Object.values(markerMap).forEach(m => map.removeLayer(m));
      Object.keys(markerMap).forEach(k => delete markerMap[k]);

      Object.entries(pins).forEach(([id, { lat, lng, name, user }]) => {
        const marker = L.marker([lat, lng]).addTo(map)
          .bindPopup(`<b>${name}</b><br>By: ${user || "Anonymous"}<br><i>Click to edit/delete</i>`);

        marker.on("click", () => {
          if (!currentUser) return alert("Sign in to edit pins.");

          const newName = prompt("Edit pin name (leave empty to delete):", name);
          if (newName === null) return;

          if (newName === "") {
            const pass = prompt("Enter password to delete this pin:");
            if (pass === PASSWORD) {
              db.ref("pins/" + id).remove();
              map.removeLayer(marker);
              alert("Pin deleted!");
            } else alert("Incorrect password.");
          } else {
            db.ref("pins/" + id).update({ name: newName });
          }
        });

        markerMap[id] = marker;
      });
    });

    // --- Add new pins ---
    map.on('click', e => {
      if (!currentUser) return alert("Please sign in to add pins.");

      const lat = e.latlng.lat, lng = e.latlng.lng;
      const temp = L.marker([lat, lng], { draggable: true }).addTo(map);
      temp.bindPopup("<button id='saveBtn'>💾 Save Pin</button> <button id='cancelBtn'>❌ Cancel Pin</button>").openPopup();

      const save = () => {
        const name = prompt("Enter pin name:", "Unnamed Pin");
        if (name) {
          const pos = temp.getLatLng();
          db.ref("pins").push({ lat: pos.lat, lng: pos.lng, name, user: currentUser.displayName });
          map.removeLayer(temp);
        } else alert("Pin not saved.");
      };

      const cancel = () => {
        const pass = prompt("Enter password to cancel:");
        if (pass === PASSWORD) { map.removeLayer(temp); alert("Pin removed."); }
        else alert("Incorrect password.");
      };

      temp.on('popupopen', () => {
        document.getElementById('saveBtn').onclick = save;
        document.getElementById('cancelBtn').onclick = cancel;
      });
    });

    // --- Locate user ---
    document.getElementById("locateBtn").onclick = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 15);
          L.marker([latitude, longitude]).addTo(map).bindPopup("📍 You are here!").openPopup();
        }, () => alert("Unable to get your location"));
      } else alert("Geolocation not supported");
    };
  </script>
</body>
</html>
