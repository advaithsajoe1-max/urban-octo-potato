<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Urban Renew - Map System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f5f5;
    }
    #map {
      height: 100%;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* Button styling (ensures it's on top and clickable) */
    #locateBtn {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 99999;               /* very high so Leaflet panes won't cover it */
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      pointer-events: auto;         /* ensure it receives clicks */
    }
    #locateBtn:hover { background: #3367d6; }

    /* Small message area for status/errors */
    #status {
      position: absolute;
      top: 60px;
      left: 12px;
      z-index: 99999;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
      max-width: 320px;
    }
  </style>
</head>
<body>
  <button id="locateBtn">üìç Find My Location</button>
  <div id="status"></div>
  <div id="map"></div>

  <script>
    // Initialize the map (default view on India)
    const map = L.map('map').setView([22.9734, 78.6569], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const statusEl = document.getElementById('status');
    let userMarker = null;

    function showStatus(msg, timeoutMs = 4000) {
      statusEl.style.display = 'block';
      statusEl.textContent = msg;
      if (timeoutMs) {
        clearTimeout(showStatus._timer);
        showStatus._timer = setTimeout(() => {
          statusEl.style.display = 'none';
        }, timeoutMs);
      }
    }

    function locateUser() {
      console.log('locateUser() called');

      // Quick checks
      if (!navigator.geolocation) {
        showStatus('Geolocation not supported by your browser.');
        console.error('Geolocation API not supported.');
        return;
      }

      // When page is embedded inside iframe, geolocation may be blocked by browser
      // or by the embedding page not allowing geolocation. Log helpful info.
      if (window.self !== window.top) {
        console.warn('Page is running inside an iframe. Geolocation may be blocked by the parent frame.');
        showStatus('Note: page is in an iframe ‚Äî geolocation may be blocked. Try opening the page directly.', 8000);
      }

      // Request location
      showStatus('Requesting location ‚Äî please allow the browser prompt...');
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          console.log('Geolocation success', pos);

          // Center map and add/update marker
          map.setView([lat, lng], 15);

          if (userMarker) {
            userMarker.setLatLng([lat, lng]);
          } else {
            userMarker = L.marker([lat, lng]).addTo(map);
            userMarker.bindPopup("<b>Your Location</b><br>Lat: " + lat.toFixed(5) + "<br>Lng: " + lng.toFixed(5));
          }
          userMarker.openPopup();
          showStatus('Location found and pinned ‚úì', 3500);
        },
        (err) => {
          console.error('Geolocation error code', err.code, err.message);
          switch(err.code) {
            case err.PERMISSION_DENIED:
              showStatus('Location permission denied. Allow location access and try again.', 8000);
              break;
            case err.POSITION_UNAVAILABLE:
              showStatus('Position unavailable. Try again or check your device settings.', 6000);
              break;
            case err.TIMEOUT:
              showStatus('Location request timed out. Try again.', 4000);
              break;
            default:
              showStatus('Unable to get location: ' + err.message, 6000);
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    document.getElementById('locateBtn').addEventListener('click', locateUser);

    // Optional: auto-locate on page load (commented out)
    // window.addEventListener('load', () => locateUser());
  </script>
</body>
</html>
